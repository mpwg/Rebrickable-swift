## Copilot coding agent instructions for Rebrickable-swift

## Purpose

This repository contains a Swift 6 client library auto-generated from the Rebrickable Lego API OpenAPI spec. The library is published as a Swift Package (`RebrickableLegoAPIClient`) with a test target. These instructions are designed to help an automated coding agent make safe, buildable changes and validate them quickly.

## High-level facts

- Repo purpose: Swift API client for Rebrickable (generated from OpenAPI, hand-fixed in places).
- Languages/targets: Swift (Swift tools v6.1), Swift Package Manager (SPM).
- Products: `RebrickableLegoAPIClient` library target and `RebrickableLegoAPIClientTests` test target.
- Important directories and files at root:
  - `Package.swift` — SPM manifest, platforms and target definitions.
  - `project.yml` — Xcode project helper metadata.
  - `README.md` and `docs/` — generated API docs.
  - `legoAPI.yaml` — OpenAPI spec used to generate code.
  - `Sources/RebrickableLegoAPIClient/` — library source (APIs, Infrastructure, OpenAPI models).
  - `Tests/RebrickableLegoAPIClientTests/` — integration tests that call the live API.
  - `.github/workflows/ci.yml` — CI (build and test) configuration.

## Build & validation (bootstrap, build, test, notes)

Follow these deterministic steps; trust these commands and only search if they fail or contradict local files.

1. Toolchain

   - Required: Swift 6.1.x (the repo and CI use Swift 6.1). Always check with `swift --version` and match CI when possible.

2. Bootstrap / dependency resolution

   - Always run: `swift package resolve`
   - If cache or previous build artifacts cause issues, run `swift package clean` before resolving.

3. Build

   - Preferred debug local build: `swift build --configuration debug`
   - The CI uses the same command; emulate CI locally to reduce surprises.

4. Tests

   - Run tests with API credentials available: the tests call the real Rebrickable API and will skip if no API key is present.
   - Export the API key (the value should be the raw API key string; do NOT prefix with `key `):
     - macOS/zsh example: `export REBRICKABLE_API_KEY="<your_api_key_here>"`
   - Run tests: `swift test --configuration debug`
   - Notes: Tests check `ProcessInfo.processInfo.environment["REBRICKABLE_API_KEY"]`; if not set they print "Skipping test because REBRICKABLE_API_KEY is not set" and return. So a missing key will not fail CI but will skip network tests locally.

5. CI

   - CI workflow path: `.github/workflows/ci.yml`.
   - CI matrix: `macos-latest`, `swift: 6.1`. CI steps:
     - Checkout
     - Cache SPM (`.build` and `.swiftpm`)
     - `swift --version`
     - `swift package resolve`
     - `swift build --configuration debug`
     - `swift test --configuration debug` (env `REBRICKABLE_API_KEY` provided from secrets)

6. Lint/Formatting
   - There are no enforced linters or formatters checked in (no `.swift-format` or `.swiftlint.yml` detected). Avoid large style-only rewrites; respect the generated code style.

## Known pitfalls and recommended mitigations

- API key handling: the library expects the API key to be set on `RebrickableLegoAPIClientAPIConfiguration.shared.apiKey` (or tests pass `RebrickableLegoAPIClientAPIConfiguration(apiKey:)`). The header sent is `authorization: key <API_KEY>`. CI supplies `REBRICKABLE_API_KEY` via secrets.
- Network tests: tests hit `https://rebrickable.com`. They require network connectivity and valid credentials. Run these tests only when network and key are available.
- Toolchain mismatch: using a different Swift toolchain (Xcode/Swift version) than CI is the most common cause of failures. Always check `swift --version` and prefer to match CI.
- Generated code: most source files were generated by OpenAPI Generator. Large sweeping changes across generated files increase the risk of CI failures. If you need to alter generated behavior, prefer small, well-justified edits and include tests.
- FatalError traps: some generated request/response paths include `fatalError` for unsupported combinations; be conservative when changing network/decoding logic.

## Project layout and key files (quick reference)

- `Package.swift` — package name, platforms (iOS 17, macOS 14, tvOS 17, watchOS 10, visionOS 1), targets, and swiftLanguageModes [.v6].
- `project.yml` — helper project metadata (used to generate or configure Xcode project files).
- `README.md` — high-level docs and generated API documentation index.
- `legoAPI.yaml` — the OpenAPI specification used to generate most code (source of truth for API surface).
- `Sources/RebrickableLegoAPIClient/APIs/LegoAPI.swift` — high-level API surface (generated methods used by callers).
- `Sources/RebrickableLegoAPIClient/Infrastructure/APIs.swift` — `RebrickableLegoAPIClientAPIConfiguration` and `RequestBuilder` configuration (apiKey, basePath, header behavior).
- `Sources/RebrickableLegoAPIClient/Infrastructure/URLSessionImplementations.swift` — network layer used by request builders and tests; includes behavior for retries, decoding and file downloads.
- `Sources/RebrickableLegoAPIClient/OpenAPIClient/Models/` — generated models for API responses.
- `Tests/RebrickableLegoAPIClientTests/LegoAPITests.swift` — integration tests that require `REBRICKABLE_API_KEY` in the environment (or will skip).
- `.github/workflows/ci.yml` — CI build/test matrix and step list.

## Rules of engagement for the coding agent

1. Trust this file as the first source of truth for common build and test steps. Only run source searches if something here fails or is incomplete.
2. Prefer small, incremental changes. Avoid wide refactors of generated code without clear tests. If a generator/regeneration is required, include the OpenAPI spec change and a regeneration plan in the PR.
3. Validate locally before opening a PR by running the exact CI steps locally: `swift package resolve`, `swift build --configuration debug`, and `REBRICKABLE_API_KEY=... swift test --configuration debug` (or ensure tests are skipped intentionally).
4. When adding or modifying tests, ensure they are deterministic and do not require secrets unless marked integration tests. Mark network-dependent tests clearly and keep them guarded by the existing `apiKeyOrSkip()` pattern.

If anything in these instructions is out-of-date with the repository files, perform a narrow search to confirm the discrepancy, then update this file and proceed.

End of instructions
